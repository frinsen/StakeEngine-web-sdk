# Crash Game - Frontend Integration

This is the frontend implementation of the Crash Game, integrated with the Stake Engine Web-SDK framework. It consumes the game logic and data generated by the Math-SDK backend.

## Overview

The crash_game frontend module:
- Displays the provably fair crash game using PixieJS/Svelte
- Consumes game data from Math-SDK (`books_base.jsonl.zst` and `lookUpTable_base_0.csv`)
- Implements interactive Storybook stories for game testing
- Uses TurboRepo for monorepo management

## Project Structure

```
src/
â”œâ”€â”€ components/          # Svelte components
â”‚   â”œâ”€â”€ Game.svelte     # Main game component
â”‚   â””â”€â”€ Symbol.svelte   # Symbol rendering
â”œâ”€â”€ game/               # Game logic
â”‚   â”œâ”€â”€ context.ts      # Game context setup
â”‚   â””â”€â”€ utils.ts        # Utility functions
â”œâ”€â”€ routes/             # SvelteKit routes
â”œâ”€â”€ stories/            # Storybook stories
â”‚   â”œâ”€â”€ ModeBaseBook.stories.svelte
â”‚   â””â”€â”€ data/
â”‚       â””â”€â”€ base_books.ts      # Game book data
â”œâ”€â”€ i18n/               # Localization
â””â”€â”€ app.html            # HTML entry point
```

## Game Data Structure

The game data follows the math-sdk output format:

```typescript
interface GameRound {
  id: number;
  payoutMultiplier: number;        // Payout multiplied by 100 (e.g., 1234 = 12.34x)
  crashPoint: number;              // Crash point (e.g., 0.11 = 0.11x)
  events: GameEvent[];
  criteria: 'basegame';
  baseGameWins: number;
  freeGameWins: number;
}

interface GameEvent {
  index: number;
  type: 'crashPointRevealed' | 'finalWin';
  crashPoint?: number;
  amount?: number;
  payout?: number;
}
```

## Running Storybook

To view and test the crash game in Storybook:

```bash
# From the web-sdk root directory
pnpm run storybook --filter=crash_game
```

This will start Storybook on port 6002. You'll see:

**Stories Available:**
- `MODE_BASE/book/random` - Random crash point from the dataset
- `MODE_BASE/book/low-crash` - Minimum crash (0.10x)
- `MODE_BASE/book/medium-crash` - Medium crash (89.97x)
- `MODE_BASE/book/high-crash` - Maximum crash (99.99x)

## Integration with Math-SDK

The crash game data is generated from the Math-SDK:

**Source**: `/Users/martinfrindt/vscode/Start/math-sdk/games/crash_game/`

**Generated Files**:
- `library/publish_files/books_base.jsonl.zst` - 10,000 game events (compressed)
- `library/publish_files/lookUpTable_base_0.csv` - O(1) crash point lookup

**To update game data:**
```bash
# Regenerate crash game from math-sdk
cd ../../math-sdk/games/crash_game
../../env/bin/python run.py

# Copy new data to frontend (manual for now)
cp library/publish_files/books_base.jsonl.zst ../../../web-sdk/apps/crash_game/public/data/
```

## Frontend Components

### Game.svelte
Main game component that:
- Renders the crash multiplier visualization
- Handles game events
- Displays payout information
- Manages game state

### Symbol.svelte
Symbol rendering component for the crash game display

## Game Logic Flow

1. **Data Loading**: Load game round from `base_books.ts`
2. **Game Start**: Initialize game state with round data
3. **Event Processing**: Process each game event sequentially
4. **Crash Point**: Display the crash point that was revealed
5. **Final Win**: Show the final payout amount
6. **Game End**: Complete the round animation

## Storybook Integration

The Storybook stories demonstrate:
- **random**: Randomly selects a crash point from the dataset
- **low-crash**: Tests minimum crash scenario (0.10x)
- **medium-crash**: Tests medium crash scenario (89.97x)
- **high-crash**: Tests maximum crash scenario (99.99x)

Each story:
- Skips the loading screen for faster testing
- Logs the crash point to the browser console
- Plays out the full game sequence
- Shows the final payout

## Testing

To test the crash game:

1. **Start Storybook**:
   ```bash
   pnpm run storybook --filter=crash_game
   ```

2. **Navigate** to `MODE_BASE/book` in the left sidebar

3. **Select** a story (e.g., "random")

4. **Click** the "Action" button in the bottom-right

5. **Watch** the game play out with the crash point

## Development

### Add New Story
Create a new `.stories.svelte` file in `src/stories/` following the pattern in `ModeBaseBook.stories.svelte`

### Modify Game Logic
Update the game logic in `src/game/` files to change behavior

### Add Components
Add new Svelte components in `src/components/`

### Build for Production
```bash
pnpm run build --filter=crash_game
```

## Dependencies

Key dependencies:
- **PixieJS**: WebGL rendering for game graphics
- **Svelte**: Component framework
- **SvelteKit**: Full-stack framework
- **Storybook**: Component testing and documentation
- **xstate**: State management for game logic
- **TypeScript**: Type-safe development

## Deployment

The crash game is packaged as a module in the TurboRepo setup and can be:
1. Built independently with `pnpm run build --filter=crash_game`
2. Served as a standalone SvelteKit app
3. Embedded as a component in larger applications
4. Published as an npm package

## Performance

- **Compression**: Uses `.zst` compression for game data (98%+ compression ratio)
- **Lookup Speed**: O(1) payout lookups from CSV table
- **Rendering**: PixieJS for efficient WebGL-based graphics
- **Bundle Size**: Optimized with tree-shaking and code splitting

## Next Steps

1. âœ… Frontend module created
2. âœ… Storybook stories configured
3. âœ… Game data integrated
4. ðŸ“‹ Custom game animations
5. ðŸ“‹ Multiplayer support
6. ðŸ“‹ Advanced analytics

## File References

- Math-SDK Crash Game: [/Users/martinfrindt/vscode/Start/math-sdk/games/crash_game/README.md](../../math-sdk/games/crash_game/README.md)
- Original Node.js Game: [/Users/martinfrindt/vscode/Start/crash-game/README.md](../../crash-game/README.md)
- Web-SDK Documentation: See `/documentation` in web-sdk root

## Support

For issues or questions:
1. Check the math-sdk crash game documentation
2. Review Storybook output in browser console
3. Check component structure in `src/components/`
4. Verify game data format in `src/stories/data/`
